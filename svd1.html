<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVD ê¸°í•˜í•™ì  ì˜ë¯¸ ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: 100vh;
        }

        .sidebar {
            background: #16213e;
            padding: 25px;
            overflow-y: auto;
            border-right: 2px solid #0f3460;
        }

        .canvas-area {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        h1 {
            color: #00d4ff;
            font-size: 26px;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .subtitle {
            text-align: center;
            color: #aaa;
            font-size: 13px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #0f3460;
        }

        .section {
            background: #0f3460;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 20px;
            border: 1px solid #1e4976;
        }

        .section-title {
            color: #00d4ff;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .matrix-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .matrix-bracket {
            font-size: 80px;
            color: #00d4ff;
            font-weight: 100;
            line-height: 0.8;
        }

        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .matrix-cell {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .matrix-cell label {
            color: #00d4ff;
            font-size: 11px;
            text-align: center;
            font-weight: bold;
        }

        .matrix-cell input {
            background: #1a1a2e;
            border: 2px solid #1e4976;
            color: #fff;
            padding: 12px 8px;
            border-radius: 6px;
            font-size: 18px;
            text-align: center;
            width: 85px;
            transition: all 0.3s;
            font-weight: bold;
        }

        .matrix-cell input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .preset-btn {
            background: #1a1a2e;
            border: 1px solid #1e4976;
            color: #00d4ff;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            background: #00d4ff;
            color: #1a1a2e;
            transform: translateY(-2px);
        }

        .control-btn {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-direct {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-direct:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-svd {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-svd:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
        }

        .btn-reset {
            background: #e74c3c;
            color: white;
        }

        .btn-reset:hover {
            background: #c0392b;
        }

        .control-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .status-box {
            background: #1a1a2e;
            border-left: 4px solid #00d4ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            min-height: 60px;
        }

        .status-title {
            color: #00d4ff;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-text {
            color: #fff;
            font-size: 14px;
            line-height: 1.6;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            width: 0%;
            transition: width 0.1s linear;
        }

        .matrix-display {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.8;
            max-height: 300px;
            overflow-y: auto;
        }

        .matrix-block {
            margin-bottom: 12px;
            padding: 10px;
            background: #16213e;
            border-radius: 4px;
            border-left: 3px solid #00d4ff;
        }

        .matrix-name {
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .matrix-values {
            color: #fff;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .controls-row button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: #1a1a2e;
            color: #00d4ff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .controls-row button:hover:not(:disabled) {
            background: #00d4ff;
            color: #1a1a2e;
        }

        .controls-row button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .speed-control {
            margin-top: 15px;
        }

        .speed-control label {
            display: block;
            color: #aaa;
            font-size: 12px;
            margin-bottom: 8px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #00d4ff;
            border-radius: 50%;
            cursor: pointer;
        }

        .info-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(22, 33, 62, 0.95);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #00d4ff;
            min-width: 250px;
            backdrop-filter: blur(10px);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .info-label {
            color: #aaa;
        }

        .info-value {
            color: #00d4ff;
            font-weight: bold;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(22, 33, 62, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #00d4ff;
            backdrop-filter: blur(10px);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 30px;
            height: 3px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <h1>SVD ì‹œë®¬ë ˆì´í„°</h1>
            <div class="subtitle">íŠ¹ì´ê°’ ë¶„í•´ì˜ ê¸°í•˜í•™ì  ì˜ë¯¸ íƒêµ¬</div>

            <!-- í–‰ë ¬ ì…ë ¥ -->
            <div class="section">
                <div class="section-title">ğŸ“Š í–‰ë ¬ A (2Ã—2)</div>
                <div class="matrix-input-container">
                    <span class="matrix-bracket">[</span>
                    <div class="matrix-grid">
                        <div class="matrix-cell">
                            <label>aâ‚â‚</label>
                            <input type="number" id="m00" value="2" step="0.1">
                        </div>
                        <div class="matrix-cell">
                            <label>aâ‚â‚‚</label>
                            <input type="number" id="m01" value="1" step="0.1">
                        </div>
                        <div class="matrix-cell">
                            <label>aâ‚‚â‚</label>
                            <input type="number" id="m10" value="1" step="0.1">
                        </div>
                        <div class="matrix-cell">
                            <label>aâ‚‚â‚‚</label>
                            <input type="number" id="m11" value="2" step="0.1">
                        </div>
                    </div>
                    <span class="matrix-bracket">]</span>
                </div>

                <div class="section-title" style="margin-top: 20px; font-size: 14px;">ğŸ¯ í”„ë¦¬ì…‹</div>
                <div class="preset-grid">
                    <button class="preset-btn" onclick="setMatrix(2, 0, 0, 1)">ìŠ¤ì¼€ì¼</button>
                    <button class="preset-btn" onclick="setMatrix(0, -1, 1, 0)">íšŒì „ 90Â°</button>
                    <button class="preset-btn" onclick="setMatrix(3, 1, 1, 3)">ëŒ€ì¹­</button>
                    <button class="preset-btn" onclick="setMatrix(2, 1, 0, 1)">ì „ë‹¨</button>
                    <button class="preset-btn" onclick="setMatrix(1.5, 0.5, 0.5, 1.5)">í˜¼í•© 1</button>
                    <button class="preset-btn" onclick="setMatrix(2, -1, 1, 2)">í˜¼í•© 2</button>
                </div>
            </div>

            <!-- ë³€í™˜ ì œì–´ -->
            <div class="section">
                <div class="section-title">ğŸ¬ ë³€í™˜ ì‹¤í–‰</div>
                <button class="control-btn btn-direct" id="directBtn">âš¡ ì§ì ‘ ë³€í™˜ (A)</button>
                <button class="control-btn btn-svd" id="svdBtn">ğŸ”¬ SVD ë‹¨ê³„ë³„ ë³€í™˜</button>
                <button class="control-btn btn-reset" id="resetBtn">â†º ë¦¬ì…‹</button>

                <div class="controls-row">
                    <button id="pauseBtn" disabled>â¸ ì¼ì‹œì •ì§€</button>
                    <button id="resumeBtn" disabled>â–¶ ì¬ìƒ</button>
                </div>

                <div class="speed-control">
                    <label>ì• ë‹ˆë©”ì´ì…˜ ì†ë„: <span id="speedValue">1.0x</span></label>
                    <input type="range" id="speedSlider" min="0.5" max="3" step="0.1" value="1">
                </div>
            </div>

            <!-- ìƒíƒœ í‘œì‹œ -->
            <div class="section">
                <div class="section-title">ğŸ“¡ ìƒíƒœ</div>
                <div class="status-box">
                    <div class="status-title">í˜„ì¬ ë‹¨ê³„</div>
                    <div class="status-text" id="statusText">ëŒ€ê¸° ì¤‘...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
            </div>

            <!-- SVD ê²°ê³¼ -->
            <div class="section">
                <div class="section-title">ğŸ” SVD ë¶„í•´ ê²°ê³¼</div>
                <div class="matrix-display" id="svdDisplay">
                    í–‰ë ¬ì„ ì…ë ¥í•˜ê³  ë³€í™˜ì„ ì‹¤í–‰í•˜ì„¸ìš”.
                </div>
            </div>
        </div>

        <!-- ìº”ë²„ìŠ¤ ì˜ì—­ -->
        <div class="canvas-area">
            <div id="canvasContainer"></div>
            
            <!-- ì •ë³´ ì˜¤ë²„ë ˆì´ -->
            <div class="info-overlay" id="infoOverlay">
                <div class="info-item">
                    <span class="info-label">í–‰ë ¬ì‹ (det):</span>
                    <span class="info-value" id="detValue">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">íŠ¹ì´ê°’ Ïƒâ‚:</span>
                    <span class="info-value" id="sigma1Value">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">íŠ¹ì´ê°’ Ïƒâ‚‚:</span>
                    <span class="info-value" id="sigma2Value">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ì¡°ê±´ìˆ˜:</span>
                    <span class="info-value" id="condValue">-</span>
                </div>
            </div>

            <!-- ë²”ë¡€ -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(100, 200, 255, 0.5); height: 4px;"></div>
                    <span>ê²©ì</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ff88; height: 4px;"></div>
                    <span>ë‹¨ìœ„ ì›</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff3366;"></div>
                    <span>íŠ¹ì´ë²¡í„° / ì£¼ì¶•</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ ì „ì—­ ë³€ìˆ˜ ============
        let canvas;
        let animating = false;
        let paused = false;
        let animationMode = null; // 'direct' or 'svd'
        let progress = 0;
        let currentStage = 0; // SVD: 0=VT, 1=Sigma, 2=U
        let speed = 1.0;
        let animationComplete = false; // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ ì—¬ë¶€

        // í–‰ë ¬ë“¤
        let A, U, Sigma, VT;
        let singularValues = [0, 0];

        // ì›ë³¸ ë„í˜•
        let originalCircle = [];
        let originalGrid = [];

        // ë³€í™˜ëœ ë„í˜• ì €ì¥ (ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ í‘œì‹œìš©)
        let displayGrid = null;
        let displayCircle = null;

        // SVD ì¤‘ê°„ ë‹¨ê³„ ì €ì¥
        let stage1Grid, stage1Circle; // VT ì ìš© í›„
        let stage2Grid, stage2Circle; // Sigma * VT ì ìš© í›„

        // ìº”ë²„ìŠ¤ ì„¤ì •
        const CANVAS_SIZE = 800;
        const SCALE = 60;
        const GRID_RANGE = 5;
        const GRID_STEP = 1;

        // ============ p5.js Setup ============
        function setup() {
            canvas = createCanvas(CANVAS_SIZE, CANVAS_SIZE);
            canvas.parent('canvasContainer');
            
            // ë‹¨ìœ„ ì› ìƒì„±
            for (let i = 0; i < 100; i++) {
                let angle = (i / 100) * TWO_PI;
                originalCircle.push(createVector(cos(angle), sin(angle)));
            }

            // ê²©ì ìƒì„±
            for (let x = -GRID_RANGE; x <= GRID_RANGE; x += GRID_STEP) {
                let vertLine = [];
                for (let y = -GRID_RANGE; y <= GRID_RANGE; y += 0.1) {
                    vertLine.push(createVector(x, y));
                }
                originalGrid.push(vertLine);
            }
            for (let y = -GRID_RANGE; y <= GRID_RANGE; y += GRID_STEP) {
                let horizLine = [];
                for (let x = -GRID_RANGE; x <= GRID_RANGE; x += 0.1) {
                    horizLine.push(createVector(x, y));
                }
                originalGrid.push(horizLine);
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('directBtn').onclick = startDirect;
            document.getElementById('svdBtn').onclick = startSVD;
            document.getElementById('resetBtn').onclick = reset;
            document.getElementById('pauseBtn').onclick = pause;
            document.getElementById('resumeBtn').onclick = resume;
            
            ['m00', 'm01', 'm10', 'm11'].forEach(id => {
                document.getElementById(id).oninput = computeSVD;
            });

            document.getElementById('speedSlider').oninput = function() {
                speed = parseFloat(this.value);
                document.getElementById('speedValue').textContent = speed.toFixed(1) + 'x';
            };

            computeSVD();
        }

        // ============ p5.js Draw Loop ============
        function draw() {
            background(26, 26, 46);
            
            // ì¢Œí‘œê³„ ë³€í™˜
            push();
            translate(width / 2, height / 2);
            scale(1, -1);

            // ì¶• ê·¸ë¦¬ê¸°
            drawAxes();

            // ì• ë‹ˆë©”ì´ì…˜ ì—…ë°ì´íŠ¸
            if (animating && !paused) {
                updateAnimation();
            }

            // ë„í˜• ê·¸ë¦¬ê¸°
            drawShapes();

            pop();
        }

        // ============ SVD ê³„ì‚° ============
        function computeSVD() {
            try {
                const a = parseFloat(document.getElementById('m00').value) || 0;
                const b = parseFloat(document.getElementById('m01').value) || 0;
                const c = parseFloat(document.getElementById('m10').value) || 0;
                const d = parseFloat(document.getElementById('m11').value) || 0;

                A = math.matrix([[a, b], [c, d]]);
                
                const svd = math.svd(A);
                U = svd.U;
                VT = math.transpose(svd.V);
                singularValues = svd.q;
                Sigma = math.matrix([[singularValues[0], 0], [0, singularValues[1]]]);

                updateSVDDisplay();
                updateInfoOverlay();
                
                console.log('SVD ê³„ì‚° ì™„ë£Œ');
                console.log('U:', U.toArray());
                console.log('Sigma:', Sigma.toArray());
                console.log('VT:', VT.toArray());
            } catch (e) {
                console.error('SVD ê³„ì‚° ì˜¤ë¥˜:', e);
                document.getElementById('svdDisplay').innerHTML = 
                    `<span style="color: #ff3366;">ì˜¤ë¥˜: ${e.message}</span>`;
            }
        }

        // ============ UI ì—…ë°ì´íŠ¸ ============
        function updateSVDDisplay() {
            const formatMat = (mat, name) => {
                const arr = mat.toArray();
                return `<div class="matrix-block">
                    <div class="matrix-name">${name}</div>
                    <div class="matrix-values">
                        [${arr[0][0].toFixed(3)}, ${arr[0][1].toFixed(3)}]<br>
                        [${arr[1][0].toFixed(3)}, ${arr[1][1].toFixed(3)}]
                    </div>
                </div>`;
            };

            let html = formatMat(A, 'A = U Î£ Váµ€');
            html += formatMat(U, 'U (ì¢Œì¸¡ íŠ¹ì´ë²¡í„°)');
            html += formatMat(Sigma, 'Î£ (íŠ¹ì´ê°’)');
            html += formatMat(VT, 'Váµ€ (ìš°ì¸¡ íŠ¹ì´ë²¡í„°)');

            document.getElementById('svdDisplay').innerHTML = html;
        }

        function updateInfoOverlay() {
            const det = math.det(A);
            const cond = singularValues[0] / (singularValues[1] + 1e-10);
            
            document.getElementById('detValue').textContent = det.toFixed(3);
            document.getElementById('sigma1Value').textContent = singularValues[0].toFixed(3);
            document.getElementById('sigma2Value').textContent = singularValues[1].toFixed(3);
            document.getElementById('condValue').textContent = cond.toFixed(2);
        }

        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        function updateProgress(p) {
            document.getElementById('progressBar').style.width = (p * 100) + '%';
        }

        // ============ ì• ë‹ˆë©”ì´ì…˜ ì œì–´ ============
        function startDirect() {
            computeSVD();
            animating = true;
            paused = false;
            animationMode = 'direct';
            animationComplete = false;
            progress = 0;
            currentStage = 0;
            displayGrid = null;
            displayCircle = null;
            updateStatus('ì§ì ‘ ë³€í™˜ (A) ì§„í–‰ ì¤‘...');
            setButtonStates(true);
            console.log('ì§ì ‘ ë³€í™˜ ì‹œì‘');
        }

        function startSVD() {
            computeSVD();
            
            // SVD ì¤‘ê°„ ë‹¨ê³„ ë¯¸ë¦¬ ê³„ì‚°
            stage1Grid = transformPoints(originalGrid, VT);
            stage1Circle = transformPoints(originalCircle, VT);
            
            const SigmaVT = math.multiply(Sigma, VT);
            stage2Grid = transformPoints(originalGrid, SigmaVT);
            stage2Circle = transformPoints(originalCircle, SigmaVT);
            
            console.log('SVD ì¤‘ê°„ ë‹¨ê³„ ê³„ì‚° ì™„ë£Œ');
            console.log('Stage 1 (VT) ì²« ì :', stage1Circle[0]);
            console.log('Stage 2 (Sigma*VT) ì²« ì :', stage2Circle[0]);
            
            animating = true;
            paused = false;
            animationMode = 'svd';
            animationComplete = false;
            progress = 0;
            currentStage = 0;
            displayGrid = null;
            displayCircle = null;
            updateStatus('1/3 ë‹¨ê³„: Váµ€ íšŒì „ ì ìš© ì¤‘...');
            setButtonStates(true);
            console.log('SVD ë‹¨ê³„ë³„ ë³€í™˜ ì‹œì‘');
        }

        function reset() {
            animating = false;
            paused = false;
            animationMode = null;
            animationComplete = false;
            progress = 0;
            currentStage = 0;
            displayGrid = null;
            displayCircle = null;
            updateStatus('ëŒ€ê¸° ì¤‘...');
            updateProgress(0);
            setButtonStates(false);
            console.log('ë¦¬ì…‹');
        }

        function pause() {
            paused = true;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = false;
        }

        function resume() {
            paused = false;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resumeBtn').disabled = true;
        }

        function setButtonStates(running) {
            document.getElementById('directBtn').disabled = running;
            document.getElementById('svdBtn').disabled = running;
            document.getElementById('pauseBtn').disabled = !running;
            document.getElementById('resumeBtn').disabled = true;
        }

        function updateAnimation() {
            progress += 0.01 * speed;

            if (progress >= 1) {
                if (animationMode === 'svd' && currentStage < 2) {
                    currentStage++;
                    progress = 0;
                    
                    const stages = [
                        '1/3 ë‹¨ê³„: Váµ€ íšŒì „ ì ìš© ì¤‘...',
                        '2/3 ë‹¨ê³„: Î£ ìŠ¤ì¼€ì¼ ì ìš© ì¤‘...',
                        '3/3 ë‹¨ê³„: U íšŒì „ ì ìš© ì¤‘...'
                    ];
                    updateStatus(stages[currentStage]);
                    console.log('SVD ë‹¤ìŒ ë‹¨ê³„ë¡œ:', currentStage + 1);
                } else {
                    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ
                    progress = 1;
                    animating = false;
                    animationComplete = true;
                    
                    // ìµœì¢… ë³€í™˜ ê²°ê³¼ ì €ì¥
                    displayGrid = transformPoints(originalGrid, A);
                    displayCircle = transformPoints(originalCircle, A);
                    
                    updateStatus('ë³€í™˜ ì™„ë£Œ! (ë¦¬ì…‹ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ˆê¸°í™”)');
                    setButtonStates(false);
                    console.log('ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ');
                }
            }

            updateProgress(animationMode === 'svd' ? 
                (currentStage + progress) / 3 : progress);
        }

        // ============ ë³€í™˜ í•¨ìˆ˜ ============
        function transform(point, matrix) {
            const arr = matrix.toArray();
            const x = point.x * arr[0][0] + point.y * arr[0][1];
            const y = point.x * arr[1][0] + point.y * arr[1][1];
            return createVector(x, y);
        }

        function transformPoints(points, matrix) {
            return points.map(p => {
                if (Array.isArray(p)) {
                    return p.map(pt => transform(pt, matrix));
                }
                return transform(p, matrix);
            });
        }

        function lerpPoints(start, end, t) {
            return start.map((p, i) => {
                if (Array.isArray(p)) {
                    return p.map((pt, j) => p5.Vector.lerp(pt, end[i][j], t));
                }
                return p5.Vector.lerp(p, end[i], t);
            });
        }

        // ============ ê·¸ë¦¬ê¸° ============
        function drawAxes() {
            stroke(50, 70, 100);
            strokeWeight(1);
            line(-width, 0, width, 0);
            line(0, -height, 0, height);

            // ëˆˆê¸ˆ
            fill(100, 120, 150);
            noStroke();
            textAlign(CENTER, CENTER);
            textSize(10);
            push();
            scale(1, -1);
            for (let i = -GRID_RANGE; i <= GRID_RANGE; i++) {
                if (i !== 0) {
                    text(i, i * SCALE, 15);
                    text(i, -20, i * SCALE);
                }
            }
            pop();
        }

        function drawShapes() {
            let currentGrid, currentCircle;

            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ì—ëŠ” ìµœì¢… ê²°ê³¼ë¥¼ ê³„ì† í‘œì‹œ
            if (animationComplete && displayGrid && displayCircle) {
                currentGrid = displayGrid;
                currentCircle = displayCircle;
            }
            // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì´ ì•„ë‹ˆê³  ì™„ë£Œë„ ì•ˆë¨ = ì´ˆê¸° ìƒíƒœ
            else if (!animating && !animationComplete) {
                currentGrid = originalGrid;
                currentCircle = originalCircle;
            }
            // ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰ ì¤‘
            else if (animating) {
                if (animationMode === 'direct') {
                    // ì§ì ‘ ë³€í™˜: ì›ë³¸ -> A
                    const endGrid = transformPoints(originalGrid, A);
                    const endCircle = transformPoints(originalCircle, A);
                    
                    currentGrid = lerpPoints(originalGrid, endGrid, progress);
                    currentCircle = lerpPoints(originalCircle, endCircle, progress);
                    
                } else if (animationMode === 'svd') {
                    // SVD 3ë‹¨ê³„ ë³€í™˜
                    if (currentStage === 0) {
                        // 1ë‹¨ê³„: ì›ë³¸ -> VT
                        currentGrid = lerpPoints(originalGrid, stage1Grid, progress);
                        currentCircle = lerpPoints(originalCircle, stage1Circle, progress);
                        
                    } else if (currentStage === 1) {
                        // 2ë‹¨ê³„: VT -> Sigma*VT
                        currentGrid = lerpPoints(stage1Grid, stage2Grid, progress);
                        currentCircle = lerpPoints(stage1Circle, stage2Circle, progress);
                        
                    } else if (currentStage === 2) {
                        // 3ë‹¨ê³„: Sigma*VT -> U*Sigma*VT (= A)
                        const finalGrid = transformPoints(originalGrid, A);
                        const finalCircle = transformPoints(originalCircle, A);
                        
                        currentGrid = lerpPoints(stage2Grid, finalGrid, progress);
                        currentCircle = lerpPoints(stage2Circle, finalCircle, progress);
                    }
                }
            }

            // ê²©ì ê·¸ë¦¬ê¸°
            if (currentGrid) {
                stroke(100, 200, 255, 80);
                strokeWeight(1);
                currentGrid.forEach(line => {
                    beginShape();
                    line.forEach(p => vertex(p.x * SCALE, p.y * SCALE));
                    endShape();
                });
            }

            // ë‹¨ìœ„ ì› ê·¸ë¦¬ê¸°
            if (currentCircle) {
                stroke(0, 255, 136);
                strokeWeight(3);
                noFill();
                beginShape();
                currentCircle.forEach(p => vertex(p.x * SCALE, p.y * SCALE));
                endShape(CLOSE);
            }

            // íŠ¹ì´ë²¡í„° í‘œì‹œ (SVD ë³€í™˜ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œ í›„)
            if ((animating && animationMode === 'svd' && currentStage >= 1) || 
                (animationComplete && animationMode === 'svd')) {
                drawSingularVectors();
            }

            // ì›ì 
            fill(255, 51, 102);
            noStroke();
            circle(0, 0, 8);
        }

        function drawSingularVectors() {
            // Uì˜ ì—´ë²¡í„° (ì¢Œì¸¡ íŠ¹ì´ë²¡í„°)
            const u1 = U.toArray().map(row => row[0]);
            const u2 = U.toArray().map(row => row[1]);

            stroke(255, 51, 102);
            strokeWeight(3);
            
            // Ïƒâ‚ * uâ‚
            const v1x = u1[0] * singularValues[0] * SCALE;
            const v1y = u1[1] * singularValues[0] * SCALE;
            line(0, 0, v1x, v1y);
            
            // Ïƒâ‚‚ * uâ‚‚
            const v2x = u2[0] * singularValues[1] * SCALE;
            const v2y = u2[1] * singularValues[1] * SCALE;
            line(0, 0, v2x, v2y);

            // í™”ì‚´í‘œ
            drawArrow(v1x, v1y);
            drawArrow(v2x, v2y);
        }

        function drawArrow(x, y) {
            push();
            translate(x, y);
            let angle = atan2(y, x);
            rotate(-angle);
            fill(255, 51, 102);
            noStroke();
            triangle(0, 0, -15, 5, -15, -5);
            pop();
        }

        // ============ ìœ í‹¸ë¦¬í‹° ============
        function setMatrix(a, b, c, d) {
            document.getElementById('m00').value = a;
            document.getElementById('m01').value = b;
            document.getElementById('m10').value = c;
            document.getElementById('m11').value = d;
            computeSVD();
        }
    </script>
</body>
</html>
