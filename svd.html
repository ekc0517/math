<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVD Í∏∞ÌïòÌïôÏ†Å ÏùòÎØ∏ ÏãúÎÆ¨Î†àÏù¥ÌÑ∞</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: 100vh;
        }

        .sidebar {
            background: #16213e;
            padding: 25px;
            overflow-y: auto;
            border-right: 2px solid #0f3460;
        }

        .canvas-area {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        h1 {
            color: #00d4ff;
            font-size: 26px;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .subtitle {
            text-align: center;
            color: #aaa;
            font-size: 13px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #0f3460;
        }

        .section {
            background: #0f3460;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 20px;
            border: 1px solid #1e4976;
        }

        .section-title {
            color: #00d4ff;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .matrix-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .matrix-bracket {
            font-size: 80px;
            color: #00d4ff;
            font-weight: 100;
            line-height: 0.8;
        }

        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .matrix-cell {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .matrix-cell label {
            color: #00d4ff;
            font-size: 11px;
            text-align: center;
            font-weight: bold;
        }

        .matrix-cell input {
            background: #1a1a2e;
            border: 2px solid #1e4976;
            color: #fff;
            padding: 12px 8px;
            border-radius: 6px;
            font-size: 18px;
            text-align: center;
            width: 85px;
            transition: all 0.3s;
            font-weight: bold;
        }

        .matrix-cell input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .preset-btn {
            background: #1a1a2e;
            border: 1px solid #1e4976;
            color: #00d4ff;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            background: #00d4ff;
            color: #1a1a2e;
            transform: translateY(-2px);
        }

        .control-btn {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-direct {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-direct:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-svd {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-svd:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
        }

        .btn-reset {
            background: #e74c3c;
            color: white;
        }

        .btn-reset:hover {
            background: #c0392b;
        }

        .control-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .status-box {
            background: #1a1a2e;
            border-left: 4px solid #00d4ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            min-height: 60px;
        }

        .status-title {
            color: #00d4ff;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-text {
            color: #fff;
            font-size: 14px;
            line-height: 1.6;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            width: 0%;
            transition: width 0.1s linear;
        }

        .matrix-display {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.8;
            max-height: 300px;
            overflow-y: auto;
        }

        .matrix-block {
            margin-bottom: 12px;
            padding: 10px;
            background: #16213e;
            border-radius: 4px;
            border-left: 3px solid #00d4ff;
        }

        .matrix-name {
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .matrix-values {
            color: #fff;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .controls-row button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: #1a1a2e;
            color: #00d4ff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .controls-row button:hover:not(:disabled) {
            background: #00d4ff;
            color: #1a1a2e;
        }

        .controls-row button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .speed-control {
            margin-top: 15px;
        }

        .speed-control label {
            display: block;
            color: #aaa;
            font-size: 12px;
            margin-bottom: 8px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #00d4ff;
            border-radius: 50%;
            cursor: pointer;
        }

        .info-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(22, 33, 62, 0.95);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #00d4ff;
            min-width: 250px;
            backdrop-filter: blur(10px);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .info-label {
            color: #aaa;
        }

        .info-value {
            color: #00d4ff;
            font-weight: bold;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(22, 33, 62, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #00d4ff;
            backdrop-filter: blur(10px);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 30px;
            height: 3px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
        <div class="sidebar">
            <h1>SVD ÏãúÎÆ¨Î†àÏù¥ÌÑ∞</h1>
            <div class="subtitle">ÌäπÏù¥Í∞í Î∂ÑÌï¥Ïùò Í∏∞ÌïòÌïôÏ†Å ÏùòÎØ∏ ÌÉêÍµ¨</div>

            <!-- ÌñâÎ†¨ ÏûÖÎ†• -->
            <div class="section">
                <div class="section-title">üìä ÌñâÎ†¨ A (2√ó2)</div>
                <div class="matrix-input-container">
                    <span class="matrix-bracket">[</span>
                    <div class="matrix-grid">
                        <div class="matrix-cell">
                            <label>a‚ÇÅ‚ÇÅ</label>
                            <input type="number" id="m00" value="2" step="0.1">
                        </div>
                        <div class="matrix-cell">
                            <label>a‚ÇÅ‚ÇÇ</label>
                            <input type="number" id="m01" value="1" step="0.1">
                        </div>
                        <div class="matrix-cell">
                            <label>a‚ÇÇ‚ÇÅ</label>
                            <input type="number" id="m10" value="1" step="0.1">
                        </div>
                        <div class="matrix-cell">
                            <label>a‚ÇÇ‚ÇÇ</label>
                            <input type="number" id="m11" value="2" step="0.1">
                        </div>
                    </div>
                    <span class="matrix-bracket">]</span>
                </div>

                <div class="section-title" style="margin-top: 20px; font-size: 14px;">üéØ ÌîÑÎ¶¨ÏÖã</div>
                <div class="preset-grid">
                    <button class="preset-btn" onclick="setMatrix(2, 0, 0, 1)">Ïä§ÏºÄÏùº</button>
                    <button class="preset-btn" onclick="setMatrix(0, -1, 1, 0)">ÌöåÏ†Ñ 90¬∞</button>
                    <button class="preset-btn" onclick="setMatrix(3, 1, 1, 3)">ÎåÄÏπ≠</button>
                    <button class="preset-btn" onclick="setMatrix(2, 1, 0, 1)">Ï†ÑÎã®</button>
                    <button class="preset-btn" onclick="setMatrix(1.5, 0.5, 0.5, 1.5)">ÌòºÌï© 1</button>
                    <button class="preset-btn" onclick="setMatrix(2, -1, 1, 2)">ÌòºÌï© 2</button>
                </div>
            </div>

            <!-- Î≥ÄÌôò Ï†úÏñ¥ -->
            <div class="section">
                <div class="section-title">üé¨ Î≥ÄÌôò Ïã§Ìñâ</div>
                <button class="control-btn btn-direct" id="directBtn">‚ö° ÏßÅÏ†ë Î≥ÄÌôò (A)</button>
                <button class="control-btn btn-svd" id="svdBtn">üî¨ SVD Îã®Í≥ÑÎ≥Ñ Î≥ÄÌôò</button>
                <button class="control-btn btn-reset" id="resetBtn">‚Ü∫ Î¶¨ÏÖã</button>

                <div class="controls-row">
                    <button id="pauseBtn" disabled>‚è∏ ÏùºÏãúÏ†ïÏßÄ</button>
                    <button id="resumeBtn" disabled>‚ñ∂ Ïû¨ÏÉù</button>
                </div>

                <div class="speed-control">
                    <label>Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÜçÎèÑ: <span id="speedValue">1.0x</span></label>
                    <input type="range" id="speedSlider" min="0.5" max="3" step="0.1" value="1">
                </div>
            </div>

            <!-- ÏÉÅÌÉú ÌëúÏãú -->
            <div class="section">
                <div class="section-title">üì° ÏÉÅÌÉú</div>
                <div class="status-box">
                    <div class="status-title">ÌòÑÏû¨ Îã®Í≥Ñ</div>
                    <div class="status-text" id="statusText">ÎåÄÍ∏∞ Ï§ë...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
            </div>

            <!-- SVD Í≤∞Í≥º -->
            <div class="section">
                <div class="section-title">üîç SVD Î∂ÑÌï¥ Í≤∞Í≥º</div>
                <div class="matrix-display" id="svdDisplay">
                    ÌñâÎ†¨ÏùÑ ÏûÖÎ†•ÌïòÍ≥† Î≥ÄÌôòÏùÑ Ïã§ÌñâÌïòÏÑ∏Ïöî.
                </div>
            </div>
        </div>

        <!-- Ï∫îÎ≤ÑÏä§ ÏòÅÏó≠ -->
        <div class="canvas-area">
            <div id="canvasContainer"></div>
            
            <!-- Ï†ïÎ≥¥ Ïò§Î≤ÑÎ†àÏù¥ -->
            <div class="info-overlay" id="infoOverlay">
                <div class="info-item">
                    <span class="info-label">ÌñâÎ†¨Ïãù (det):</span>
                    <span class="info-value" id="detValue">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ÌäπÏù¥Í∞í œÉ‚ÇÅ:</span>
                    <span class="info-value" id="sigma1Value">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ÌäπÏù¥Í∞í œÉ‚ÇÇ:</span>
                    <span class="info-value" id="sigma2Value">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Ï°∞Í±¥Ïàò:</span>
                    <span class="info-value" id="condValue">-</span>
                </div>
            </div>

            <!-- Î≤îÎ°Ä -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(100, 200, 255, 0.5); height: 4px;"></div>
                    <span>Í≤©Ïûê</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ff88; height: 4px;"></div>
                    <span>Îã®ÏúÑ Ïõê</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff3366;"></div>
                    <span>ÌäπÏù¥Î≤°ÌÑ∞ / Ï£ºÏ∂ï</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ Ï†ÑÏó≠ Î≥ÄÏàò ============
        let canvas;
        let animating = false;
        let paused = false;
        let animationMode = null;
        let progress = 0;
        let currentStage = 0;
        let speed = 1.0;
        let animationComplete = false;

        // ÌñâÎ†¨Îì§ (Î∞∞Ïó¥ ÌòïÌÉúÎ°ú Ï†ÄÏû•)
        let matrixA = [[1, 0], [0, 1]];
        let matrixU = [[1, 0], [0, 1]];
        let matrixSigma = [[1, 0], [0, 1]];
        let matrixVT = [[1, 0], [0, 1]];
        let singularValues = [1, 1];

        // ÏõêÎ≥∏ ÎèÑÌòï
        let originalCircle = [];
        let originalGrid = [];

        // Î≥ÄÌôòÎêú ÎèÑÌòï Ï†ÄÏû•
        let displayGrid = null;
        let displayCircle = null;

        // SVD Ï§ëÍ∞Ñ Îã®Í≥Ñ Ï†ÄÏû•
        let stage1Grid, stage1Circle;
        let stage2Grid, stage2Circle;

        // Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï
        const CANVAS_SIZE = 800;
        const SCALE = 60;
        const GRID_RANGE = 5;
        const GRID_STEP = 1;

        // ============ p5.js Setup ============
        function setup() {
            canvas = createCanvas(CANVAS_SIZE, CANVAS_SIZE);
            canvas.parent('canvasContainer');
            
            // Îã®ÏúÑ Ïõê ÏÉùÏÑ±
            for (let i = 0; i < 100; i++) {
                let angle = (i / 100) * TWO_PI;
                originalCircle.push(createVector(cos(angle), sin(angle)));
            }

            // Í≤©Ïûê ÏÉùÏÑ±
            for (let x = -GRID_RANGE; x <= GRID_RANGE; x += GRID_STEP) {
                let vertLine = [];
                for (let y = -GRID_RANGE; y <= GRID_RANGE; y += 0.1) {
                    vertLine.push(createVector(x, y));
                }
                originalGrid.push(vertLine);
            }
            for (let y = -GRID_RANGE; y <= GRID_RANGE; y += GRID_STEP) {
                let horizLine = [];
                for (let x = -GRID_RANGE; x <= GRID_RANGE; x += 0.1) {
                    horizLine.push(createVector(x, y));
                }
                originalGrid.push(horizLine);
            }

            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            document.getElementById('directBtn').onclick = startDirect;
            document.getElementById('svdBtn').onclick = startSVD;
            document.getElementById('resetBtn').onclick = reset;
            document.getElementById('pauseBtn').onclick = pause;
            document.getElementById('resumeBtn').onclick = resume;
            
            ['m00', 'm01', 'm10', 'm11'].forEach(id => {
                document.getElementById(id).oninput = computeSVD;
            });

            document.getElementById('speedSlider').oninput = function() {
                speed = parseFloat(this.value);
                document.getElementById('speedValue').textContent = speed.toFixed(1) + 'x';
            };

            computeSVD();
        }

        // ============ p5.js Draw Loop ============
        function draw() {
            background(26, 26, 46);
            
            push();
            translate(width / 2, height / 2);
            scale(1, -1);

            drawAxes();

            if (animating && !paused) {
                updateAnimation();
            }

            drawShapes();

            pop();
        }

        // ============ SVD Í≥ÑÏÇ∞ ============
        function computeSVD() {
            try {
                const a = parseFloat(document.getElementById('m00').value) || 0;
                const b = parseFloat(document.getElementById('m01').value) || 0;
                const c = parseFloat(document.getElementById('m10').value) || 0;
                const d = parseFloat(document.getElementById('m11').value) || 0;

                // math.jsÎ°ú SVD Í≥ÑÏÇ∞
                const A = math.matrix([[a, b], [c, d]]);
                const svd = math.svd(A);
                
                // Í≤∞Í≥ºÎ•º Î∞∞Ïó¥Î°ú Ï†ÄÏû•
                matrixA = [[a, b], [c, d]];
                matrixU = svd.U.toArray();
                singularValues = svd.q;
                matrixSigma = [[singularValues[0], 0], [0, singularValues[1]]];
                matrixVT = math.transpose(svd.V).toArray();

                console.log('SVD Í≥ÑÏÇ∞ ÏôÑÎ£å');
                console.log('A:', matrixA);
                console.log('U:', matrixU);
                console.log('Sigma:', matrixSigma);
                console.log('VT:', matrixVT);
                console.log('ÌäπÏù¥Í∞í:', singularValues);

                updateSVDDisplay();
                updateInfoOverlay();
                
            } catch (e) {
                console.error('SVD Í≥ÑÏÇ∞ Ïò§Î•ò:', e);
                document.getElementById('svdDisplay').innerHTML = 
                    `<span style="color: #ff3366;">Ïò§Î•ò: ${e.message}</span>`;
            }
        }

        // ============ UI ÏóÖÎç∞Ïù¥Ìä∏ ============
        function updateSVDDisplay() {
            const formatMat = (mat, name) => {
                return `<div class="matrix-block">
                    <div class="matrix-name">${name}</div>
                    <div class="matrix-values">
                        [${mat[0][0].toFixed(3)}, ${mat[0][1].toFixed(3)}]<br>
                        [${mat[1][0].toFixed(3)}, ${mat[1][1].toFixed(3)}]
                    </div>
                </div>`;
            };

            let html = formatMat(matrixA, 'A = U Œ£ V·µÄ');
            html += formatMat(matrixU, 'U (Ï¢åÏ∏° ÌäπÏù¥Î≤°ÌÑ∞)');
            html += formatMat(matrixSigma, 'Œ£ (ÌäπÏù¥Í∞í)');
            html += formatMat(matrixVT, 'V·µÄ (Ïö∞Ï∏° ÌäπÏù¥Î≤°ÌÑ∞)');

            document.getElementById('svdDisplay').innerHTML = html;
        }

        function updateInfoOverlay() {
            const det = matrixA[0][0] * matrixA[1][1] - matrixA[0][1] * matrixA[1][0];
            const cond = singularValues[0] / (singularValues[1] + 1e-10);
            
            document.getElementById('detValue').textContent = det.toFixed(3);
            document.getElementById('sigma1Value').textContent = singularValues[0].toFixed(3);
            document.getElementById('sigma2Value').textContent = singularValues[1].toFixed(3);
            document.getElementById('condValue').textContent = cond.toFixed(2);
        }

        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        function updateProgress(p) {
            document.getElementById('progressBar').style.width = (p * 100) + '%';
        }

        // ============ Î≥ÄÌôò Ìï®Ïàò ============
        function applyMatrix(point, matrix) {
            const x = point.x * matrix[0][0] + point.y * matrix[0][1];
            const y = point.x * matrix[1][0] + point.y * matrix[1][1];
            return createVector(x, y);
        }

        function transformGrid(grid, matrix) {
            const result = [];
            for (let i = 0; i < grid.length; i++) {
                const line = [];
                for (let j = 0; j < grid[i].length; j++) {
                    line.push(applyMatrix(grid[i][j], matrix));
                }
                result.push(line);
            }
            return result;
        }

        function transformCircle(circle, matrix) {
            const result = [];
            for (let i = 0; i < circle.length; i++) {
                result.push(applyMatrix(circle[i], matrix));
            }
            return result;
        }

        function multiplyMatrices(m1, m2) {
            return [
                [
                    m1[0][0] * m2[0][0] + m1[0][1] * m2[1][0],
                    m1[0][0] * m2[0][1] + m1[0][1] * m2[1][1]
                ],
                [
                    m1[1][0] * m2[0][0] + m1[1][1] * m2[1][0],
                    m1[1][0] * m2[0][1] + m1[1][1] * m2[1][1]
                ]
            ];
        }

        function lerpGrid(startGrid, endGrid, t) {
            const result = [];
            for (let i = 0; i < startGrid.length; i++) {
                const line = [];
                for (let j = 0; j < startGrid[i].length; j++) {
                    line.push(p5.Vector.lerp(startGrid[i][j], endGrid[i][j], t));
                }
                result.push(line);
            }
            return result;
        }

        function lerpCircle(startCircle, endCircle, t) {
            const result = [];
            for (let i = 0; i < startCircle.length; i++) {
                result.push(p5.Vector.lerp(startCircle[i], endCircle[i], t));
            }
            return result;
        }

        // ============ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†úÏñ¥ ============
        function startDirect() {
            computeSVD();
            animating = true;
            paused = false;
            animationMode = 'direct';
            animationComplete = false;
            progress = 0;
            currentStage = 0;
            displayGrid = null;
            displayCircle = null;
            updateStatus('ÏßÅÏ†ë Î≥ÄÌôò (A) ÏßÑÌñâ Ï§ë...');
            setButtonStates(true);
            console.log('ÏßÅÏ†ë Î≥ÄÌôò ÏãúÏûë');
        }

        function startSVD() {
            try {
                computeSVD();
                
                console.log('SVD Î≥ÄÌôò ÏãúÏûë - Ï§ëÍ∞Ñ Îã®Í≥Ñ Í≥ÑÏÇ∞');
                
                // Stage 1: VT Ï†ÅÏö©
                stage1Grid = transformGrid(originalGrid, matrixVT);
                stage1Circle = transformCircle(originalCircle, matrixVT);
                console.log('Stage 1 (VT) Í≥ÑÏÇ∞ ÏôÑÎ£å');
                
                // Stage 2: Sigma * VT Ï†ÅÏö©
                const sigmaVT = multiplyMatrices(matrixSigma, matrixVT);
                stage2Grid = transformGrid(originalGrid, sigmaVT);
                stage2Circle = transformCircle(originalCircle, sigmaVT);
                console.log('Stage 2 (Sigma*VT) Í≥ÑÏÇ∞ ÏôÑÎ£å');
                
                animating = true;
                paused = false;
                animationMode = 'svd';
                animationComplete = false;
                progress = 0;
                currentStage = 0;
                displayGrid = null;
                displayCircle = null;
                updateStatus('1/3 Îã®Í≥Ñ: V·µÄ ÌöåÏ†Ñ Ï†ÅÏö© Ï§ë...');
                setButtonStates(true);
                console.log('SVD Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë');
            } catch (e) {
                console.error('SVD ÏãúÏûë Ïò§Î•ò:', e);
                alert('SVD Î≥ÄÌôò ÏãúÏûë Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + e.message);
            }
        }

        function reset() {
            animating = false;
            paused = false;
            animationMode = null;
            animationComplete = false;
            progress = 0;
            currentStage = 0;
            displayGrid = null;
            displayCircle = null;
            updateStatus('ÎåÄÍ∏∞ Ï§ë...');
            updateProgress(0);
            setButtonStates(false);
            console.log('Î¶¨ÏÖã');
        }

        function pause() {
            paused = true;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = false;
        }

        function resume() {
            paused = false;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resumeBtn').disabled = true;
        }

        function setButtonStates(running) {
            document.getElementById('directBtn').disabled = running;
            document.getElementById('svdBtn').disabled = running;
            document.getElementById('pauseBtn').disabled = !running;
            document.getElementById('resumeBtn').disabled = true;
        }

        function updateAnimation() {
            progress += 0.01 * speed;

            if (progress >= 1) {
                if (animationMode === 'svd' && currentStage < 2) {
                    currentStage++;
                    progress = 0;
                    
                    const stages = [
                        '1/3 Îã®Í≥Ñ: V·µÄ ÌöåÏ†Ñ Ï†ÅÏö© Ï§ë...',
                        '2/3 Îã®Í≥Ñ: Œ£ Ïä§ÏºÄÏùº Ï†ÅÏö© Ï§ë...',
                        '3/3 Îã®Í≥Ñ: U ÌöåÏ†Ñ Ï†ÅÏö© Ï§ë...'
                    ];
                    updateStatus(stages[currentStage]);
                    console.log('Îã§Ïùå Îã®Í≥Ñ:', currentStage + 1);
                } else {
                    progress = 1;
                    animating = false;
                    animationComplete = true;
                    
                    // ÏµúÏ¢Ö Î≥ÄÌôò Í≤∞Í≥º Ï†ÄÏû•
                    displayGrid = transformGrid(originalGrid, matrixA);
                    displayCircle = transformCircle(originalCircle, matrixA);
                    
                    updateStatus('Î≥ÄÌôò ÏôÑÎ£å! (Î¶¨ÏÖã Î≤ÑÌäºÏùÑ ÎàåÎü¨ Ï¥àÍ∏∞Ìôî)');
                    setButtonStates(false);
                    console.log('Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å');
                }
            }

            updateProgress(animationMode === 'svd' ? 
                (currentStage + progress) / 3 : progress);
        }

        // ============ Í∑∏Î¶¨Í∏∞ ============
        function drawAxes() {
            stroke(50, 70, 100);
            strokeWeight(1);
            line(-width, 0, width, 0);
            line(0, -height, 0, height);

            fill(100, 120, 150);
            noStroke();
            textAlign(CENTER, CENTER);
            textSize(10);
            push();
            scale(1, -1);
            for (let i = -GRID_RANGE; i <= GRID_RANGE; i++) {
                if (i !== 0) {
                    text(i, i * SCALE, 15);
                    text(i, -20, i * SCALE);
                }
            }
            pop();
        }

        function drawShapes() {
            let currentGrid, currentCircle;

            if (animationComplete && displayGrid && displayCircle) {
                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ
                currentGrid = displayGrid;
                currentCircle = displayCircle;
            } else if (!animating && !animationComplete) {
                // Ï¥àÍ∏∞ ÏÉÅÌÉú
                currentGrid = originalGrid;
                currentCircle = originalCircle;
            } else if (animating) {
                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏßÑÌñâ Ï§ë
                if (animationMode === 'direct') {
                    const endGrid = transformGrid(originalGrid, matrixA);
                    const endCircle = transformCircle(originalCircle, matrixA);
                    
                    currentGrid = lerpGrid(originalGrid, endGrid, progress);
                    currentCircle = lerpCircle(originalCircle, endCircle, progress);
                    
                } else if (animationMode === 'svd') {
                    if (currentStage === 0) {
                        // Stage 0: ÏõêÎ≥∏ -> VT
                        currentGrid = lerpGrid(originalGrid, stage1Grid, progress);
                        currentCircle = lerpCircle(originalCircle, stage1Circle, progress);
                        
                    } else if (currentStage === 1) {
                        // Stage 1: VT -> Sigma*VT
                        currentGrid = lerpGrid(stage1Grid, stage2Grid, progress);
                        currentCircle = lerpCircle(stage1Circle, stage2Circle, progress);
                        
                    } else if (currentStage === 2) {
                        // Stage 2: Sigma*VT -> A
                        const finalGrid = transformGrid(originalGrid, matrixA);
                        const finalCircle = transformCircle(originalCircle, matrixA);
                        
                        currentGrid = lerpGrid(stage2Grid, finalGrid, progress);
                        currentCircle = lerpCircle(stage2Circle, finalCircle, progress);
                    }
                }
            }

            // Í≤©Ïûê Í∑∏Î¶¨Í∏∞
            if (currentGrid) {
                stroke(100, 200, 255, 80);
                strokeWeight(1);
                for (let i = 0; i < currentGrid.length; i++) {
                    beginShape();
                    for (let j = 0; j < currentGrid[i].length; j++) {
                        vertex(currentGrid[i][j].x * SCALE, currentGrid[i][j].y * SCALE);
                    }
                    endShape();
                }
            }

            // Îã®ÏúÑ Ïõê Í∑∏Î¶¨Í∏∞
            if (currentCircle) {
                stroke(0, 255, 136);
                strokeWeight(3);
                noFill();
                beginShape();
                for (let i = 0; i < currentCircle.length; i++) {
                    vertex(currentCircle[i].x * SCALE, currentCircle[i].y * SCALE);
                }
                endShape(CLOSE);
            }

            // ÌäπÏù¥Î≤°ÌÑ∞ ÌëúÏãú
            if ((animating && animationMode === 'svd' && currentStage >= 1) || 
                (animationComplete && animationMode === 'svd')) {
                drawSingularVectors();
            }

            // ÏõêÏ†ê
            fill(255, 51, 102);
            noStroke();
            circle(0, 0, 8);
        }

        function drawSingularVectors() {
            const u1 = [matrixU[0][0], matrixU[1][0]];
            const u2 = [matrixU[0][1], matrixU[1][1]];

            stroke(255, 51, 102);
            strokeWeight(3);
            
            const v1x = u1[0] * singularValues[0] * SCALE;
            const v1y = u1[1] * singularValues[0] * SCALE;
            line(0, 0, v1x, v1y);
            
            const v2x = u2[0] * singularValues[1] * SCALE;
            const v2y = u2[1] * singularValues[1] * SCALE;
            line(0, 0, v2x, v2y);

            drawArrow(v1x, v1y);
            drawArrow(v2x, v2y);
        }

        function drawArrow(x, y) {
            push();
            translate(x, y);
            let angle = atan2(y, x);
            rotate(-angle);
            fill(255, 51, 102);
            noStroke();
            triangle(0, 0, -15, 5, -15, -5);
            pop();
        }

        // ============ Ïú†Ìã∏Î¶¨Ìã∞ ============
        function setMatrix(a, b, c, d) {
            document.getElementById('m00').value = a;
            document.getElementById('m01').value = b;
            document.getElementById('m10').value = c;
            document.getElementById('m11').value = d;
            computeSVD();
        }
    </script>
</body>
</html>
